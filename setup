#!/bin/bash
SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"
FILES=$(find lib ! -path lib -type f)
COUNT=0

mkdir -p ~/.vim/tmp/undo
mkdir -p ~/.vim/tmp/backup
mkdir -p ~/.vim/tmp/swap
mkdir -p ~/.config/mpd/res
touch ~/.config/mpd/log

curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
curl -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

/usr/bin/vim +PlugInstall +qall
/usr/bin/nvim +PlugInstall +qall
/usr/bin/nvim +CocInstall coc-tsserver +qall

for LIBFILE in $FILES; do
    FILE=${LIBFILE:4}
    printf("%q" "$FILE")
    DIR=$(dirname "$HOME/$FILE")
    BACKUPFILE="$SCRIPTPATH/back/$FILE"
    BACKUPDIR=$(dirname "$SCRIPTPATH/back/$FILE")

    mkdir -p "$DIR"
    mkdir -p "$BACKUPDIR"

    if [ -f "$HOME/$FILE" ]; then
        cp "$HOME/$FILE" "$BACKUPFILE"
        rm "$HOME/$FILE"
    fi

    ln -s -f "$SCRIPTPATH/lib/$FILE" "$HOME/$FILE" 2>&1 >/dev/null
    ((COUNT++))
    echo -e -n "\e[36mUpdated $COUNT files.\e[0m\r"
done
echo -e "\e[36mUpdated $COUNT files.\e[0m"

fc-cache

systemctl enable --user synccal.timer
systemctl restart --user synccal.timer
systemctl enable --user sync_music.timer
systemctl restart --user sync_music.timer
systemctl enable --user mpd.service
systemctl restart --user mpd.service
